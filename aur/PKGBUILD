# Maintainer: Steve Seguin <steve@seguin.email>
# Contributor: Artur Stuhl <150718978+Arthur-Stuhl@users.noreply.github.com>
   
   # Copyright (C) <2025>  # Maintainer: Steve Seguin <steve@seguin.email>
   # Contributor: Artur Stuhl <150718978+Arthur-Stuhl@users.noreply.github.com>

    # This program is free software: you can redistribute it and/or modify
    # it under the terms of the GNU Affero General Public License as
    # published by the Free Software Foundation, either version 3 of the
    # License, or (GPLv3) any later version.

    # This program is distributed in the hope that it will be useful,
    # but WITHOUT ANY WARRANTY; without even the implied warranty of
    # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    # GNU Affero General Public License for more details.

    # You should have received a copy of the GNU Affero General Public License
    # along with this program.  If not, see <https://www.gnu.org/licenses/>.

_pkgname=socialstreamninja
pkgname=socialstreamninja
pkgver=0.3.43
pkgrel=1
pkgdesc='Social media content management and analytics platform / AppImage version'
arch=(x86_64)
url="https://github.com/steveseguin/social_stream/"
license=(GPLv3)
depends=(zlib fuse glibc kdialog xdg-user-dirs qt6-base)
optdepends=('ffmpeg: Video processing support' 'gtk3: For Gnome style theming' 'nss' 'libxss' 'libnotify:For notifications' 'libxtst')
provides=('socialstreamninja')
conflicts=('socialstreamninja')
options=(!strip !debug)
_appimage="socialstreamninja_linux_v${pkgver}_x86_64.AppImage"
noextract=("${_appimage}")
source=("${_appimage}::${url}/releases/download/${pkgver}/${_appimage}")
sha256sums=('cffc5c85902e39a11112108bd306baf4b0903714982575a43ab036e9ae411c33')
appname="socialstreamninja"

prepare() {
    chmod +x "${_appimage}"
    ./"${_appimage}" --appimage-extract
}
package() {
  # Move all extracted squashfs-root contents to /opt/socialstreamninja
  install -d "${pkgdir}/opt/socialstreamninja"
  cp -r squashfs-root/* "${pkgdir}/opt/socialstreamninja/"

  # Fix ownership and permissions
  chown -R root:root "${pkgdir}/opt/socialstreamninja"
  find "${pkgdir}/opt/socialstreamninja" -type d -exec chmod 755 {} \;
  find "${pkgdir}/opt/socialstreamninja" -type f -exec chmod 644 {} \;
  chmod +x "${pkgdir}/opt/socialstreamninja/socialstreamninja"  # Make main binary executable

  # Copy and modify .desktop file from the AppImage (embedded in squashfs-root)
  install -d "${pkgdir}/usr/share/applications"
  desktop_file="${pkgdir}/usr/share/applications/socialstreamninja.desktop"

  # Extract the .desktop file from the AppImage (if it exists in squashfs-root)
  if [ -f "${pkgdir}/opt/socialstreamninja/socialstreamninja.desktop" ]; then
    cp "${pkgdir}/opt/socialstreamninja/socialstreamninja.desktop" "${desktop_file}"
  else
    echo "No .desktop file found in AppImage. Creating a minimal one." >&2
    cat <<EOF > "${desktop_file}"
[Desktop Entry]
Name=Social Stream Ninja
Comment=Standalone application for capturing social media streams
Exec=/opt/socialstreamninja/socialstreamninja %U
Terminal=false
Type=Application
Icon=socialstreamninja
Categories=AudioVideo;
StartupNotify=true
MimeType=x-scheme-handler/https;x-scheme-handler/http;
EOF
  fi

  # Fix paths in the .desktop file
  sed -i \
    -e 's|Exec=.*|Exec=/opt/socialstreamninja/socialstreamninja %U|' \
    -e 's|Icon=.*|Icon=/opt/socialstreamninja/socialstreamninja.png|' \
    "${desktop_file}"

  # Install icon (if present in the AppImage)
  install -d "${pkgdir}/usr/share/icons/hicolor/256x256/apps"
  if [ -f "${pkgdir}/opt/socialstreamninja/socialstreamninja.png" ]; then
    cp -f "${pkgdir}/opt/socialstreamninja/socialstreamninja.png" \
      "${pkgdir}/usr/share/icons/hicolor/256x256/apps/socialstreamninja.png"
  fi
}
